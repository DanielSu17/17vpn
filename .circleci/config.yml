version: 2

notify:
  # Notify phabricator about result
  webhooks:
    - url: https://media17.phacility.com/harbormaster/hook/circleci/

references:
  default: &default
    environment:
      TZ: "/usr/share/zoneinfo/Asia/Taipei"
    docker:
      - image: circleci/python:3.7

  tag_filter_pr_build: &tag_filter_pr_build
    filters:
      branches:
        only:
          - /^pull\/.*$/

jobs:
  build:
    <<: *default
    steps:
      - checkout
      - run:
          name: syntax check
          command: |
            sudo pip install -r ./circle/requirements.txt
            echo "syntax check - start"
            ./circle/syntax_checker.py
            echo "syntax check - end"
  deploy:
    <<: *default
    steps:
      - run:
          name: deliver configuration to GCP
          command: |
            curl -sSL --fail -w "%{http_code}\n" -o /dev/null "${DEPLOY_TO_GCP_URL}&REVISION=${CIRCLE_SHA1}"

workflows:
  version: 2
  all:
    jobs:
      - build
        #- deploy:
        #    requires:
        #    - build
        #    filters:
        #      branches:
        #        only:
        #        - master
  pr-build:
    jobs:
      - build:
          <<: *tag_filter_pr_build
