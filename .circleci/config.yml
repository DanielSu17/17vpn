version: 2

references:
  default: &default
    environment:
      TZ: "/usr/share/zoneinfo/Asia/Taipei"
    docker:
      - image: circleci/python:3.7

  tag_filter_pr_build: &tag_filter_pr_build
    filters:
      branches:
        only:
          - /^pull\/.*$/

jobs:
  build:
    <<: *default
    steps:
      - checkout
      - run:
          name: python requirements
          command: |
            sudo pip install -r ./circle/requirements.txt
      - run:
          name: syntax check
          command: |
            echo "syntax check - start"
            ./circle/syntax_checker.py
            echo "syntax check - end"

            # FIXME: should send slack notification if check failed
      - run:
          name: duplicate user check
          command: |
            echo "duplicate user check - start"
            ./circle/check_duplicate_users.py
            echo "duplicate user check - end"

            # FIXME: should send slack notification if check failed
  deploy:
    <<: *default
    steps:
      - run:
          name: deliver configuration
          command: |
            curl -sSL --fail -w "%{http_code}\n" -o /dev/null "${DEPLOY_TO_GCP_URL}&REVISION=${CIRCLE_SHA1}"

workflows:
  version: 2
  all:
    jobs:
      - build
      - deploy:
          requires:
          - build
          filters:
            branches:
              only:
              - master
  pr-build:
    jobs:
      - build:
          <<: *tag_filter_pr_build
